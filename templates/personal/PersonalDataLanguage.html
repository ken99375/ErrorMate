{% extends "personal_base.html" %}
{% set active_key = "language" %} {% block title %}言語種別比率 - ErrorMate{% endblock %}

{% block personal_content %}
<div class="analysis-container">
    <h2>言語種別比率</h2>
    <div style="max-width: 500px; margin: 0 auto;">
        <canvas id="languageChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // -------------------------------------------------------------
    // API エンドポイントからデータを取得
    // Python側で関数 language_ratio_data のURLを /api/... に変更したので
    // url_for は自動的にその新しいAPIのURLを生成します。
    // -------------------------------------------------------------
    fetch("{{ url_for('personal.language_ratio_data') }}")
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);  // デバッグ用
            
            // データが空の場合の表示
            if (!data.labels || data.labels.length === 0) {
                const container = document.getElementById('languageChart').parentElement;
                container.innerHTML = '<p style="text-align:center; margin-top:20px;">表示するデータがありません</p>';
                return;
            }

            // グラフの色設定
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
            ];

            // グラフ描画
            const ctx = document.getElementById('languageChart').getContext('2d');
            const languageChart = new Chart(ctx, {
                type: 'pie', // 円グラフ
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: colors.slice(0, data.labels.length),
                        borderColor: 'rgba(255, 255, 255, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: 'タグ（言語種別）の割合'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            const container = document.getElementById('languageChart').parentElement;
            container.innerHTML = '<p style="text-align:center; color:red;">データ取得に失敗しました</p>';
        });
</script>
{% endblock %}