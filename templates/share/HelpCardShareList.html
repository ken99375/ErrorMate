{% extends "base.html" %}

{% block title %}ãƒ˜ãƒ«ãƒ—ã‚«ãƒ¼ãƒ‰å…±æœ‰ä¸€è¦§ - ErrorMate{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/share/helpcardshare.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã®ç°¡æ˜“ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ã¨å…±é€šï¼‰ */
    .pagination { display: flex; list-style: none; padding: 0; justify-content: center; gap: 5px; margin-top: 30px;}
    .page-link { padding: 8px 12px; border: 1px solid #ddd; color: #333; text-decoration: none; border-radius: 4px; }
    .page-item.active .page-link { background-color: #007bff; color: white; border-color: #007bff; }
    .page-item.disabled .page-link { color: #ccc; pointer-events: none; }
    
    /* ã„ã„ã­ãƒœã‚¿ãƒ³ */
    .like-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #ccc;
        transition: color 0.2s;
    }
    .like-btn.liked {
        color: #e53935;
    }
    .like-count {
        margin-left: 5px;
        font-size: 1rem;
        color: #555;
    }
</style>
{% endblock %}

{% block content %}

    <div class="d-flex align-items-center mb-4" style="justify-content:flex-start;">
        <form class="d-flex" method="get" action="{{ url_for('share.share_help_card_list') }}">
            <input
                type="text"
                id="tagInput"
                name="tag"
                class="form-control me-2"
                placeholder="ã‚¿ã‚°æ¤œç´¢æ¬„ï¼ˆè¤‡æ•°ã¯ã‚«ãƒ³ãƒ or ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰"
                style="max-width:400px;font-size:1.2rem;"
                value="{{ keyword|e }}"
            >
            <button id="searchBtn" type="submit" class="btn btn-outline-primary" style="font-size:1.1rem;">ğŸ”</button>
        </form>
    </div>

    {% if keyword %}
    <div class="mb-3">
        <h5>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ã€Œ{{ keyword|e }}ã€</h5>
    </div>
    {% endif %}

    {% if matches.items %}
    <div class="row">

        {% for card in matches.items %}
        <div class="col-md-4 mb-4">
            <div class="help-card p-3">
                <h5 class="card-title text-center">{{ card.title }}</h5>

                <div class="card-body">
                    <div class="info-label">ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:</div>
                    <pre class="code-box">{{ card.error_code }}</pre>

                    <div class="info-label">ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</div>
                    <div class="text-box">{{ card.error_message }}</div>
                </div>

                <div class="card-footer">
                    <div class="meta">
                        {{ card.author.user_name if card.author else 'ä¸æ˜' }}
                        {% if card.tags %}
                            {% for t in card.tags %} 
                                <span class="badge bg-secondary">#{{ t.tag_name }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="actions">
                        <button class="like-btn {{ 'liked' if card.card_id in liked_ids else '' }}" 
                                data-card="{{ card.card_id }}" 
                                data-auth="{{ 1 if logged_in else 0 }}" 
                                data-login="{{ url_for('auth.login') }}"
                                aria-pressed="{{ 'true' if card.card_id in liked_ids else 'false' }}">
                                  
                            <i class="fa-icon {{ 'fa-solid' if card.card_id in liked_ids else 'fa-regular' }} fa-heart"></i>
                            <span class="like-count" id="count-{{ card.card_id }}">
                                {{ like_counts.get(card.card_id, 0) }}
                            </span>
                        </button>
                    
                        <a href="{{ url_for('share.share_help_card_detail', card_id=card.card_id) }}" class="answer-link">å›ç­”ã™ã‚‹</a>
                          
                        {% set delete_url = None %}
                        
                        {% if current_user.is_authenticated %}
                            {% if current_user.role == 'student' and card.user_id == current_user.user_id %}
                                {% set delete_url = url_for('share.delete_my_help_card', card_id=card.card_id) %}
                            {% elif current_user.role == 'teacher' %}
                                {% set delete_url = url_for('share.admin_delete_shared_help_card', card_id=card.card_id) %}
                            {% endif %}
                        {% endif %}
                        
                        {% if delete_url %}
                        <button type="button"
                                class="action-btn action-btn--danger js-open-delete"
                                data-action="{{ delete_url }}"
                                data-title="{{ card.title|e }}">
                            å‰Šé™¤
                        </button>
                        {% endif %}


                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if current_user.is_authenticated and current_user.role in ['teacher', 'student'] %}
      {% set delete_msg = 'ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' if current_user.role == 'teacher'
                          else 'ã“ã®ãƒ˜ãƒ«ãƒ—ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' %}
    
      <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">å‰Šé™¤ç¢ºèª</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
            </div>
    
            <div class="modal-body">
              <p class="mb-0">{{ delete_msg }}</p>
              <small class="text-muted" id="deleteTargetTitle"></small>
            </div>
    
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <form method="POST" id="deleteConfirmForm" style="display:inline;">
                <button type="submit" class="btn btn-danger">å‰Šé™¤ã™ã‚‹</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endif %}



    {% if matches.pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item {% if not matches.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for(request.endpoint, page=matches.prev_num, tag=keyword) }}">å‰ã¸</a>
            </li>
            {% for page_num in matches.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    <li class="page-item {% if page_num == matches.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=page_num, tag=keyword) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            <li class="page-item {% if not matches.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for(request.endpoint, page=matches.next_num, tag=keyword) }}">æ¬¡ã¸</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="alert alert-warning">è©²å½“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    {% endif %}

{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='js/share/help_cards.js') }}"></script>
{% endblock %}
